<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CQL Runner (two uploads)</title>
  <style>
    body { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; padding: 16px; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 10px; }
    label { min-width: 120px; }
    input[type="text"] { width: min(980px, 100%); padding: 6px; }
    input[type="file"] { padding: 6px; }
    button { padding: 6px 10px; }
    button:disabled { opacity: 0.5; }
    #log { white-space: pre-wrap; background: #0b0f14; color: #e8eef7; padding: 12px; border-radius: 8px; min-height: 280px; }
    .muted { opacity: 0.75; }
    .hint { font-size: 12px; opacity: 0.75; }
    .mono { font-family: inherit; }
  </style>
</head>
<body>
  <h1>CQL Runner</h1>

  <div class="row">
    <label for="cqlFile">CQL file:</label>
    <input id="cqlFile" type="file" accept=".cql" />
    <span id="cqlChosen" class="muted"></span>
  </div>

  <div class="row">
    <label for="pgnFile">PGN file:</label>
    <input id="pgnFile" type="file" accept=".pgn" />
    <span id="pgnChosen" class="muted"></span>
  </div>

  <div class="row">
    <label for="argv">Argv string:</label>
    <input id="argv" type="text" value="-q /work/query.cql -game /work/game.pgn" />
  </div>
  <div class="row hint">
    <span>
      This is the <b>full argv string</b> passed to <span class="mono">main(argv)</span>.
      Your worker writes files to <span class="mono">/work/query.cql</span> and <span class="mono">/work/game.pgn</span>.
    </span>
  </div>

  <div class="row">
    <button id="runBtn" disabled>Run</button>
    <button id="clearBtn">Clear log</button>
    <span id="status" class="muted">Ready. Choose files.</span>
  </div>

  <h3>Console</h3>
  <div id="log"></div>

  <h3>output.pgn history</h3>
  <div id="outputs"></div>

  <script type="module">
    import { runCqlWasm } from "./cql_runner.js";

    const logEl = document.getElementById('log');
    const statusEl = document.getElementById('status');
    const runBtn = document.getElementById('runBtn');
    const clearBtn = document.getElementById('clearBtn');
    const cqlInput = document.getElementById('cqlFile');
    const pgnInput = document.getElementById('pgnFile');
    const cqlChosen = document.getElementById('cqlChosen');
    const pgnChosen = document.getElementById('pgnChosen');
    const outputsEl = document.getElementById('outputs');
    const argvEl = document.getElementById('argv');

    function log(line) {
      logEl.textContent += line + "\n";
      logEl.scrollTop = logEl.scrollHeight;
      console.log(line);
    }

    function describeErr(e) {
      if (e instanceof Error) return e.stack || e.message || String(e);
      if (e && typeof e === "object") {
        const parts = [];
        for (const k of ["name","message","errno","code","path","stack"]) {
          if (e[k] != null) parts.push(`${k}=${String(e[k])}`);
        }
        try { parts.push("json=" + JSON.stringify(e)); } catch {}
        return parts.join(" | ") || "[object Object]";
      }
      return String(e);
    }

    window.addEventListener("error", (e) => {
      log("[window.error] " + (e.message || e));
      if (e.error) log("[window.error.detail] " + describeErr(e.error));
    });

    window.addEventListener("unhandledrejection", (e) => {
      log("[unhandledrejection] " + describeErr(e.reason));
    });

    clearBtn.addEventListener("click", () => {
      logEl.textContent = "";
    });

    function updateChosenLabels() {
      cqlChosen.textContent = cqlInput.files?.[0] ? cqlInput.files[0].name : "";
      pgnChosen.textContent = pgnInput.files?.[0] ? pgnInput.files[0].name : "";
      runBtn.disabled = !(cqlInput.files?.[0] && pgnInput.files?.[0]);
    }
    cqlInput.addEventListener("change", updateChosenLabels);
    pgnInput.addEventListener("change", updateChosenLabels);

    async function fileToUint8(file) {
      const ab = await file.arrayBuffer();
      return new Uint8Array(ab);
    }

    function appendOutputPgn(title, text) {
      const d = document.createElement("details");
      d.open = false;

      const s = document.createElement("summary");
      s.textContent = title;

      const pre = document.createElement("pre");
      pre.style.whiteSpace = "pre-wrap";
      pre.style.margin = "10px 0 0 0";
      pre.textContent = text;

      d.appendChild(s);
      d.appendChild(pre);
      outputsEl.appendChild(d);
    }

    runBtn.addEventListener("click", async () => {
      runBtn.disabled = true;

      try {
        const cqlFile = cqlInput.files?.[0];
        const pgnFile = pgnInput.files?.[0];
        if (!cqlFile) throw new Error("Pick a .cql file.");
        if (!pgnFile) throw new Error("Pick a .pgn file.");

        statusEl.textContent = "Reading files…";
        const [cqlBytes, pgnBytes] = await Promise.all([fileToUint8(cqlFile), fileToUint8(pgnFile)]);

        const argvString = argvEl.value;

        const startedAt = new Date();
        const title = `Run ${startedAt.toLocaleString()} — ${cqlFile.name} + ${pgnFile.name}`;

        // Call the single API
        const job = runCqlWasm(cqlBytes, pgnBytes, argvString, {
          onLog: (line) => log(line)
        });

        // Subscribe to job updates (non-blocking, you can render incremental state)
        const unsub = job.subscribe((j) => {
          const { busy, total } = j.status();
          statusEl.textContent = `${j.state} — workers ${busy}/${total}` + (j.error ? ` — ${j.error}` : "");
          if (j.state === "done" || j.state === "error") {
            unsub();
            appendOutputPgn(title, j.outputPgn || "");
            if (j.outputMissing) log("[warn] output.pgn not found (empty entry added).");
            if (j.state === "done") log("[info] done rc=" + String(j.rc));
          }
        });

        statusEl.textContent = "running…";
      } catch (e) {
        log("[exception] " + describeErr(e));
        statusEl.textContent = "Error (see console).";
      } finally {
        updateChosenLabels();
      }
    });

    // initial
    updateChosenLabels();
  </script>
</body>
</html>
